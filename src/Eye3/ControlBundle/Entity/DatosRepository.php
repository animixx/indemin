<?php

namespace Eye3\ControlBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Eye3\ControlBundle\Entity\Datos;

/**
 * DatosRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DatosRepository extends EntityRepository
{

		public function findMax()
		{
			$query = $this->getEntityManager()
				->createQuery(
					'SELECT p FROM Eye3ControlBundle:Datos p'
				)->setMaxResults(10000);

			try {
				return $query->getResult();
			} catch (\Doctrine\ORM\NoResultException $e) {
				return null;
			}
		}
		
		public function primer_dato($formato = "%d-%m-%Y")
		{
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'SELECT date_format(min(dato.inicio),"'.$formato.'") as inicio FROM datos dato order by dato.inicio limit 1'
				);

			$query->execute();
			 
			return $query->fetchAll();
			 
		}
		
		public function camiones($where = '', $fecha = null )
		{
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'SELECT DISTINCT id_tag_camiones as tag,(select nombre_camion from camiones where id= id_tag_camiones) as camion FROM datos '.$where
				);
			 if ($fecha) $query->bindValue('fecha', $fecha );
				
			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "Y-m-d"
		public function tiempo_dia($fecha)
		{
//grupo de pruebas solo grua 1 ->2013-08-15  , las 2 gruas -> (2014-06-16, 2014-06-12 ,2014-07-10) , solo grua 2 -> 2014-06-07
			
		 
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones, SUM(duracion) as tiempo_total, SEC_TO_TIME(avg(duracion)) as prom, count(*) as veces, grua FROM datos where date(inicio) = :fecha  group by camion, grua ) 
				 union
					(SELECT null,null, SEC_TO_TIME(SUM(duracion)) , null, COUNT(DISTINCT(id_tag_camiones)) , grua FROM datos  where date(inicio) = :fecha GROUP BY grua) 
					 ORDER BY grua, id_tag_camiones'
				);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
			 
		}
		
		//formato fecha llegada "Y-m-d"
		public function tiempo_semana($fecha)
		{
		 
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones, SUM(duracion) as tiempo_total, SEC_TO_TIME(avg(duracion)) as prom, count(*) as veces, grua FROM datos where DATE_FORMAT(inicio,"%u-%Y") = DATE_FORMAT( :fecha ,"%u-%Y" ) group by camion, grua ) 
				 union
					(SELECT null,null, SEC_TO_TIME(SUM(duracion)) , null, COUNT(DISTINCT(id_tag_camiones)) , grua FROM datos  where DATE_FORMAT(inicio,"%u-%Y") = DATE_FORMAT( :fecha ,"%u-%Y" ) GROUP BY grua) 
					ORDER BY grua, id_tag_camiones'
				);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
			 
		}
		
		//formato fecha llegada "Y-m-d"
		public function tiempo_mes($fecha)
		{
			
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones, SUM(duracion) as tiempo_total, SEC_TO_TIME(avg(duracion)) as prom, count(*) as veces, grua FROM datos where  DATE_FORMAT(inicio,"%m-%Y") = DATE_FORMAT( :fecha ,"%m-%Y" ) group by camion, grua ) 
				 union
					(SELECT null,null, SEC_TO_TIME(SUM(duracion)) , null, COUNT(DISTINCT(id_tag_camiones)) , grua FROM datos  where  DATE_FORMAT(inicio,"%m-%Y") = DATE_FORMAT( :fecha ,"%m-%Y" ) GROUP BY grua) 
					ORDER BY grua, id_tag_camiones'
				);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
			 
		}
		
		//formato fecha llegada "Y-m-d" 
		public function camion_dia($fecha )
		{
		// (SELECT camion,grua,null as inicio,SEC_TO_TIME(min(duracion)) as tiempo,SEC_TO_TIME(max(duracion)) as max,SEC_TO_TIME(avg(TIME_TO_SEC(duracion))) as prom,SEC_TO_TIME(sum(TIME_TO_SEC(duracion))) as suma, count(*) as cuantos FROM datos WHERE date(inicio) = '2014-10-27'  GROUP BY camion,grua )
		// union
		// (SELECT camion,grua,inicio,DATE_FORMAT(duracion,"%i,%s"),null,null,null,null FROM datos WHERE  date(inicio) = '2014-11-03'  )
		//  ORDER BY grua, camion,max desc  , inicio
//grupo de pruebas solo grua 1 ->2013-09-24  , las 2 gruas -> (2014-06-16) , solo grua 2 -> 2014-06-07

			
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones,grua,null as inicio,SEC_TO_TIME(min(duracion)) as tiempo,SEC_TO_TIME(max(duracion)) as max,SEC_TO_TIME(avg(duracion)) as prom,SEC_TO_TIME(sum(duracion)) as suma, count(*) as cuantos FROM datos WHERE DATE_FORMAT(inicio,"%d-%m-%Y") = DATE_FORMAT(:fecha,"%d-%m-%Y") GROUP BY camion,grua )
				union
					 (SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones,grua,inicio, round(duracion) ,null,null,null,null FROM datos WHERE DATE_FORMAT(inicio,"%d-%m-%Y") = DATE_FORMAT(:fecha,"%d-%m-%Y") )
					 ORDER BY grua, id_tag_camiones, max desc , inicio'

			);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "Y-m-d" 
		public function camion_semana($fecha)
		{

			
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion, id_tag_camiones,grua,DATE(inicio) as dia, SEC_TO_TIME(min(duracion)) as min,SEC_TO_TIME(max(duracion)) as max,SEC_TO_TIME(avg(duracion)) as prom ,round(sum(duracion)) as suma, count(*) as veces, null as dias FROM datos WHERE  DATE_FORMAT(inicio,"%u-%Y") = DATE_FORMAT( :fecha ,"%u-%Y" ) GROUP BY camion,grua ,date(inicio))
						union
					(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion, id_tag_camiones,grua,null, SEC_TO_TIME(min(duracion)) ,SEC_TO_TIME(max(duracion)),SEC_TO_TIME(avg(duracion)) ,SEC_TO_TIME(sum(duracion)) , count(*),count(distinct(date(inicio)))  FROM datos WHERE  DATE_FORMAT(inicio,"%u-%Y") = DATE_FORMAT( :fecha ,"%u-%Y" ) GROUP BY camion,grua )
					 ORDER BY grua,  id_tag_camiones, dia'

			);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "Y-m-d" 
		public function camion_mes($fecha)
		{

			
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion, id_tag_camiones,grua,week(inicio,1) as semana, SEC_TO_TIME(min(duracion)) as min,SEC_TO_TIME(max(duracion)) as max,SEC_TO_TIME(avg(duracion)) as prom ,round(sum(duracion)) as suma, count(*) as veces, count(distinct(date(inicio))) as dias, null as selector FROM datos WHERE  DATE_FORMAT(inicio,"%m-%Y") = DATE_FORMAT( :fecha ,"%m-%Y" ) GROUP BY camion,grua ,week(inicio,1))
						union
					(SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion, id_tag_camiones,grua,count(distinct(week(inicio,1))), SEC_TO_TIME(min(duracion)) ,SEC_TO_TIME(max(duracion)),SEC_TO_TIME(avg(duracion)) ,SEC_TO_TIME(sum(duracion)) , count(*),count(distinct(date(inicio))),1  FROM datos WHERE  DATE_FORMAT(inicio,"%m-%Y") = DATE_FORMAT( :fecha ,"%m-%Y" ) GROUP BY camion,grua )
					 ORDER BY grua,  id_tag_camiones, selector desc, semana'

			);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "yyyyWu" (semana)
		public function reporte_semana($fecha)
		{	
			if (substr($fecha,4,3)=="W01")
			$corrigesql= "DATE_FORMAT(inicio,\"%YW%u\") =  \"".(substr($fecha,0,4)-1)."W53\" or";
			else $corrigesql = "";
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					' SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones, grua, min( duracion ) as min,max( duracion ) as max, avg( duracion ) as prom ,sum( duracion ) as suma, count(*) as veces ,count(DISTINCT (DATE(inicio))) as dias FROM datos 
					WHERE '.$corrigesql.' DATE_FORMAT(inicio,"%YW%u") = :fecha 
					GROUP BY id_tag_camiones,grua'

			);
				$query->bindValue('fecha', $fecha );

			 $query->execute();
			 
			 return $query->fetchAll();
		}		
		
		//formato fecha llegada "yyyy/mm"
		public function reporte_mes($fecha)
		{

			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					' SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones, grua, min( duracion ) AS min, max( duracion ) AS max, avg( duracion ) AS prom, sum( duracion ) AS suma, count( * ) AS veces, count( DISTINCT (date( inicio ) ) ) AS dias FROM datos
					WHERE DATE_FORMAT( inicio, "%m-%Y" ) = DATE_FORMAT( :fecha, "%m-%Y" )
					GROUP BY id_tag_camiones,grua'

			);
				$query->bindValue('fecha', $fecha."/1" );

			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "yyyyWu" (semana)
		public function reporte_semana2($fecha,$grua = "Grúa-1")
		{
			if (substr($fecha,4,3)=="W01")
			$corrigesql= "DATE_FORMAT(inicio,\"%YW%u\") =  \"".(substr($fecha,0,4)-1)."W53\" or";
			else $corrigesql = "";
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					' SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones,grua, min(duracion) as min ,max(duracion) as max ,avg(duracion) as prom ,sum(duracion) as suma, count(*) as veces, DATE_FORMAT(inicio,"%w") as ndia, date(inicio) as dia FROM datos 
					WHERE ('.$corrigesql.' DATE_FORMAT(inicio,"%YW%u") = :fecha ) and grua = :grua 
					GROUP BY camion,date(inicio)
					 ORDER BY  id_tag_camiones, dia'
			);
				$query->bindValue('fecha', $fecha );
				$query->bindValue('grua', $grua );

			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "yyyy/mm"
		public function reporte_mes2($fecha,$grua = "Grúa-1")
		{

			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					' (SELECT (select nombre_camion from camiones where id= id_tag_camiones) as camion,id_tag_camiones,week(inicio,1) as semana, min(duracion) as min,max(duracion) as max,avg(duracion) as prom ,sum(duracion) as suma, count(*) as veces, count(distinct(date(inicio))) as dias  FROM datos 
					WHERE  DATE_FORMAT(inicio,"%m-%Y") = DATE_FORMAT( :fecha,"%m-%Y" ) and grua = :grua GROUP BY camion ,week(inicio,1))
					 ORDER BY id_tag_camiones,semana'

			);
				$query->bindValue('fecha', $fecha."/1" );
				$query->bindValue('grua', $grua );

			 $query->execute();
			 
			 return $query->fetchAll();
		}	
		
		//formato fecha desde y hasta "yyyy-mm-dd"
		public function historial_excel($desde = "2013-08-15" ,$hasta = "2013-08-16")
		{

			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'SELECT * FROM datos d join camiones c on d.id_tag_camiones=c.id WHERE  inicio BETWEEN :desde and :hasta order by id'

			);
				$query->bindValue('desde', $desde );
				$query->bindValue('hasta', $hasta );

			 $query->execute();
			 
			 return $query->fetchAll();
		}
		
		//formato fecha llegada "Y-m-d"
		public function grua_dia($fecha )
		{
			//SELECT * FROM datos p WHERE p.inicio like '2013-09-24%' ORDER BY p.grua, p.inicio
			//SELECT  SUM(TIME_TO_SEC(duracion))  as uso, TIME_TO_SEC(SUBTIME('24:00:00', SEC_TO_TIME(SUM(TIME_TO_SEC(duracion))))) as muerto,  count(*) as ciclos, SEC_TO_TIME(AVG(TIME_TO_SEC(duracion)))  as prom, grua   FROM datos  where inicio LIKE  '2013-09-24%' GROUP BY grua
			//select id ,(select min(id) from datos where id>t1.id and grua=t1.grua ) as next, camion, grua ,(select grua from datos where id=next) as 'p-grua', inicio, (select inicio from datos where id=next) as 'p-inicio',duracion ,TIMEDIFF((select inicio from datos where id=next),inicio) as proximo from datos as t1 where inicio like  '2013-09-24%' order by grua,inicio
			
			$fecha += "%";
			
			$query = $this->getEntityManager()
				->getConnection()
				->prepare(
					'SELECT SUM(TIME_TO_SEC(duracion)) as uso, TIME_TO_SEC(SUBTIME("24:00:00", SEC_TO_TIME(SUM(duracion)))) as muerto,  count(*) as ciclos, SEC_TO_TIME(AVG(duracion)) as prom, grua FROM datos where inicio LIKE :fecha GROUP BY grua'
				

			);
				
			$query2 = $this->getEntityManager()
				->getConnection()
				->prepare(
					'select (select min(id) from datos where id>t1.id and grua=t1.grua ) as next, (select nombre_camion from camiones where id= id_tag_camiones) as camion, grua , inicio, duracion ,TIME_TO_SEC(TIMEDIFF((select inicio from datos where id=next),inicio)) as proximo from datos as t1 where inicio like :fecha order by grua,inicio'
				

			);
			
			$query->bindValue('fecha', $fecha );
			$query2->bindValue('fecha', $fecha );

			$query->execute();
			$query2->execute();
			 
			return array(
				'pie' => $query->fetchAll(),
				'trenes' => $query2->fetchAll(),
			 );
		}

}
